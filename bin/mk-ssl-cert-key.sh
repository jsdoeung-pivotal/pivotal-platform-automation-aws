#!/bin/bash
set -e
set -u # explode if any env vars are not set

SCRIPTDIR=$(cd $(dirname "$0") && pwd -P)

#DOMAIN=${PKS_SUBDOMAIN_NAME}.${PKS_DOMAIN_NAME}

mkdir -p ~/certs

KEY_BITS=2048
DAYS=365

openssl req -new -x509 -nodes -sha256 -newkey rsa:${KEY_BITS} -days ${DAYS} \
  -keyout ~/certs/${DOMAIN}.ca.key.pkcs8 \
  -out ~/certs/${DOMAIN}.ca.crt \
  -config <( cat << EOF
[ req ]
prompt = no
distinguished_name    = dn
[ dn ]
C  = US
O = Pivotal
CN = Toolsmiths autogenerated CA
EOF
)

openssl rsa \
  -in ~/certs/${DOMAIN}.ca.key.pkcs8 \
  -out ~/certs/${DOMAIN}.ca.key

openssl req -nodes -sha256 -newkey rsa:${KEY_BITS} -days ${DAYS} \
  -keyout ~/certs/${DOMAIN}.key \
  -out ~/certs/${DOMAIN}.csr \
  -config <( cat << EOF
[ req ]
prompt = no
distinguished_name = dn
req_extensions = v3_req
[ dn ]
C  = US
O = Pivotal
CN = *.${DOMAIN}
[ v3_req ]
subjectAltName = DNS:*.${DOMAIN}, DNS:*.apps.${DOMAIN}, DNS:*.sys.${DOMAIN}, DNS:*.login.sys.${DOMAIN}, DNS:*.uaa.sys.${DOMAIN}, DNS:*.pks.${DOMAIN}
EOF
)

openssl x509 -req -sha256 -days ${DAYS} \
  -in ~/certs/${DOMAIN}.csr \
  -CA ~/certs/${DOMAIN}.ca.crt \
  -CAkey ~/certs/${DOMAIN}.ca.key.pkcs8 -CAcreateserial \
  -out ~/certs/${DOMAIN}.host.crt \
  -extfile <( cat << EOF
basicConstraints = CA:FALSE
subjectAltName = DNS:*.${DOMAIN}, DNS:*.apps.${DOMAIN}, DNS:*.sys.${DOMAIN}, DNS:*.login.sys.${DOMAIN}, DNS:*.uaa.sys.${DOMAIN}, DNS:*.pks.${DOMAIN}
subjectKeyIdentifier = hash
EOF
)

cat ~/certs/${DOMAIN}.host.crt ~/certs/${DOMAIN}.ca.crt > ~/certs/${DOMAIN}.crt
